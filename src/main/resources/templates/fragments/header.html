<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:fragment="header">
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <!-- Custom styles for this template -->
    <!-- <link th:href="@{/css/jumbotron-narrow.css}" rel="stylesheet">-->
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <title>Smart ShoppingMall</title>
    <script th:inline="javascript">

        let memberId = [[${session.memberId}]];

        if (memberId !== null) {
            const socket = new SockJS('/ws');
            const stompClient = Stomp.over(socket);

            stompClient.connect({}, function () {
                stompClient.subscribe('/topic/notifications/' + memberId, function (notification) {
                    const data = JSON.parse(notification.body);
                    showNotification(data);
                    addAlarmItem(data);
                    updateAlarmCount(1);
                });
            });
        }

        function showNotification(data) {
            alert("üîî " + data.title + ": " + data.content); // Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï Í∞ÄÎä•
            // TODO: ÏïåÎ¶º Î±ÉÏßÄ Ï¶ùÍ∞Ä, UI ÏóÖÎç∞Ïù¥Ìä∏ Îì±
        }

        function toggleAlarmPanel() {
            const panel = document.getElementById("alarmPanel");
            panel.style.display = (panel.style.display === "none") ? "block" : "none";
        }

        function addAlarmItem(alarm) {
            const list = document.getElementById("alarmList");
            const item = document.createElement("div");
            item.className = "border-bottom py-2";

            item.innerHTML = `
                <div><strong>${alarm.title}</strong></div>
                <div class="text-muted small">${alarm.time}</div>
                <div class="mt-1">
                    <button class="btn btn-sm btn-outline-success me-2">ÏùΩÏùå</button>
                    <button class="btn btn-sm btn-outline-danger">ÏÇ≠Ï†ú</button>
                </div>
            `;

            list.prepend(item);
        }

        function updateAlarmCount(diff) {
            const badge = document.getElementById("alarmCount");
            let count = parseInt(badge.textContent) || 0;
            count += diff;
            badge.textContent = count > 0 ? count : '';
        }
    </script>
</head>
