<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header"/>
<body>
<div class="container">
    <div th:replace="fragments/bodyHeader :: bodyHeader"/>

    <h2>장바구니</h2>

    <form th:action="@{/buyer/order/new/cartOrders}" method="post">
        <table class="table table-striped">
            <thead>
            <tr>
                <th><input type="checkbox" id="selectAll" checked onclick="toggleAll(this)"></th>
                <th>상품 이미지</th>
                <th>상품명</th>
                <th>가격</th>
                <th>수량</th>
                <th>총 가격</th>
                <th>액션</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item, stat : ${cartItems}">
                <td>
                    <input type="checkbox"
                           th:name="'productId['+${stat.index}+']'"
                           th:value="${item.productId}"
                           checked>
                </td>
                <td>
                    <img th:src="${item.mainImageUrl}" alt="상품 이미지" width="50">
                </td>
                <td th:text="${item.productName}">상품명</td>
                <td th:text="${item.price}">가격</td>
                <td>
                    <input type="number"
                           th:name="'quantity['+${stat.index}+']'"
                           th:value="${item.quantity}"
                           min="1"
                           onchange="updateQuantity(this, [[${item.productId}]])"/>
                </td>
                <td th:text="${item.totalPrice}">총 가격</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm"
                            onclick="removeCartItem([[${item.cartItemId}]])">
                        삭제
                    </button>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="text-right">
            <strong>총 장바구니 금액: </strong>
            <span th:text="${totalCartPrice}">0</span> 원
        </div>

        <div class="mt-3">
            <button type="submit" class="btn btn-primary">선택한 상품 주문</button>
        </div>
    </form>

    <div th:replace="fragments/footer :: footer"/>
</div>

<script>
    function updateQuantity(input, productId) {
        const quantity = input.value;

        fetch('/buyer/cart/update', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
            },
            body: JSON.stringify({
                productId: productId,
                quantity: quantity
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('수량 업데이트 실패');
            }
            return response.json();
        })
        .then(data => {
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('수량 업데이트 중 오류가 발생했습니다.');
        });
    }

    function removeCartItem(cartItemId) {
        fetch(`/buyer/cart/remove/${cartItemId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('장바구니 아이템 삭제 실패');
            }
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('장바구니 아이템 삭제 중 오류가 발생했습니다.');
        });
    }

    // 전체 선택/해제 기능
    function toggleAll(source) {
        let checkboxes = document.querySelectorAll('input[type="checkbox"][name^="selected"]');
        checkboxes.forEach(checkbox => checkbox.checked = source.checked);
    }
</script>
</body>
</html>
